<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lab Scheduling</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --text:#e7ecff;
      --muted:#b8c0e0;
      --line:#22305e;
      --accent:#7aa2ff;
      --good:#35d07f;
      --bad:#ff5c7a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, #1a2a66 0%, var(--bg) 60%),
                  radial-gradient(1200px 800px at 90% 20%, #3b1a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      padding:18px 18px 0;
      max-width:1400px;
      margin:0 auto;
    }
    .titlebar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .subtitle{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      max-width:920px;
    }
    main{
      padding:14px 18px 24px;
      max-width:1400px;
      margin:0 auto;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls, .rightControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tabs{
      display:inline-flex;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      padding:4px;
      gap:4px;
    }
    .tab{
      border:0;
      color:var(--muted);
      background:transparent;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(122,162,255,.18);
      color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(122,162,255,.25);
    }

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{
      background:rgba(122,162,255,.18);
      border-color:rgba(122,162,255,.25);
    }
    .btn.danger{
      background:rgba(255,92,122,.12);
      border-color:rgba(255,92,122,.28);
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="text"]{
      background:rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      min-width:240px;
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(184,192,224,.75)}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .chip strong{color:var(--text); font-weight:700}
    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.35;
    }

    .gridWrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      margin-top:12px;
      background:rgba(0,0,0,.12);
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
      width:100%;
      font-size:12px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:rgba(10,14,30,.92);
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 8px;
      text-align:left;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }
    thead th:first-child{left:0; z-index:6;}
    tbody th{
      position:sticky;
      left:0;
      z-index:4;
      background:rgba(10,14,30,.92);
      backdrop-filter: blur(6px);
      border-right:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-weight:700;
      padding:10px 8px;
      white-space:nowrap;
      font-family:var(--mono);
    }
    td{
      border-bottom:1px solid rgba(255,255,255,.07);
      border-right:1px solid rgba(255,255,255,.07);
      padding:8px;
      vertical-align:top;
      min-width:190px;
      background:rgba(17,26,51,.35);
    }
    tr:last-child td{border-bottom:0}
    td:last-child{border-right:0}

    .slot{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:92px;
    }
    select{
      width:100%;
      background:rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:7px 8px;
      font-size:12px;
      outline:none;
    }
    .slotTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .who{
      font-weight:700;
      color:var(--text);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:140px;
    }
    .smallBtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      cursor:pointer;
    }
    .smallBtn:hover{border-color:rgba(255,255,255,.18)}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:5px 8px;
      font-size:11px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      width:max-content;
    }
    .badge.bad{background:rgba(255,92,122,.12); border-color:rgba(255,92,122,.25); color:var(--text)}
    .badge.good{background:rgba(53,208,127,.12); border-color:rgba(53,208,127,.22); color:var(--text)}
    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    label{display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none; color:var(--muted);}
    input[type="checkbox"]{width:15px;height:15px;accent-color:var(--accent);}

    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 1050px){
      .twoCol{grid-template-columns:1fr}
      table{min-width:920px}
    }
    .hidden{display:none !important}

    .toast{
      position:fixed;
      bottom:16px;
      right:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      color:var(--text);
      max-width:min(560px, calc(100vw - 32px));
      display:none;
    }
    .toast.show{display:block}

    /* Admin dropdown */
    .menuWrap{position:relative; display:inline-block;}
    .menu{
      position:absolute;
      right:0;
      top:42px;
      width:min(360px, calc(100vw - 24px));
      background:rgba(10,14,30,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:12px;
      z-index:50;
      display:none;
    }
    .menu.show{display:block}
    .menu h3{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--text);
    }
    .menuRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .menuRow .chip{flex:1}
    .menuRow select, .menuRow input{
      flex:1;
      min-width:140px;
    }
    .menu small{color:var(--muted); display:block; line-height:1.35;}
  </style>
</head>

<body>
<header>
  <div class="titlebar">
    <div>
      <h1>Lab Scheduling</h1>
      <p class="subtitle">
        1-hour slots. Weekdays are <strong>Mon–Fri, 09:00–17:00</strong>. Weekend scheduling is in a separate tab.
        Schedules are scoped to <strong>Year + Term + Week</strong>.
      </p>
    </div>
    <div class="inline" style="align-items:center;">
      <span class="chip" id="termChip">Term: <strong>—</strong></span>
      <span class="chip" id="weekChip">Week: <strong>—</strong></span>
      <div class="menuWrap">
        <button class="btn" id="adminBtn" type="button">Admin ▾</button>
        <div class="menu" id="adminMenu" aria-label="Admin menu">
          <h3>Admin</h3>
          <div class="menuRow">
            <div style="flex:1;">
              <small>Year</small>
              <select id="yearSelect"></select>
            </div>
            <div style="flex:1;">
              <small>Term</small>
              <select id="termSelect">
                <option value="Spring">Jan–Apr (Spring)</option>
                <option value="Fall">Sep–Dec (Fall)</option>
              </select>
            </div>
          </div>
          <div class="menuRow">
            <button class="btn primary" id="applyTermBtn" type="button">Apply Year/Term</button>
            <button class="btn danger" id="resetWeekBtn" type="button">Reset this week</button>
          </div>
          <div class="menuRow" style="margin-bottom:0;">
            <button class="btn danger" id="resetAllBtn" type="button">Reset ALL data</button>
          </div>
          <small style="margin-top:10px;">
            Reset this week clears only the currently displayed week (both contexts, weekdays+weekend) for the selected Year/Term.
            Reset ALL wipes names and all schedules stored in this browser.
          </small>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="controls">
      <div class="leftControls">
        <div class="tabs" role="tablist" aria-label="Schedule range">
          <button class="tab active" id="tab-weekdays" type="button">Weekdays</button>
          <button class="tab" id="tab-weekend" type="button">Weekend</button>
        </div>

        <div class="tabs" role="tablist" aria-label="Context display">
          <button class="tab active" id="view-both" type="button">Both</button>
          <button class="tab" id="view-abc" type="button">ABC only</button>
          <button class="tab" id="view-hf" type="button">HF only</button>
        </div>

        <div class="inline">
          <button class="btn" id="prevWeekBtn" type="button">◀ Prev week</button>
          <button class="btn" id="nextWeekBtn" type="button">Next week ▶</button>
        </div>
      </div>

      <div class="rightControls">
        <div class="field">
          <input id="nameInput" type="text" placeholder="Add person (e.g., Jane Doe) and press Enter" />
          <button class="btn primary" id="addNameBtn" type="button">Add</button>
        </div>
        <button class="btn" id="exportBtn" type="button">Export</button>
        <button class="btn" id="importBtn" type="button">Import</button>
      </div>
    </div>

    <p class="note" id="termNote">
      Term limits: Jan–Apr (Spring) and Sep–Dec (Fall). Week navigation is constrained to the active term.
    </p>
  </div>

  <div class="twoCol" style="margin-top:12px;">
    <section class="panel" id="panelABC">
      <div class="inline" style="justify-content:space-between;">
        <div class="inline">
          <span class="chip">Context: <strong>ABC Lab</strong></span>
        </div>
        <span class="badge" id="abcSummary">0 filled</span>
      </div>
      <div class="gridWrap" id="gridWrapABC"></div>
    </section>

    <section class="panel" id="panelHF">
      <div class="inline" style="justify-content:space-between;">
        <div class="inline">
          <span class="chip">Context: <strong>HF Project</strong></span>
        </div>
        <span class="badge" id="hfSummary">0 filled</span>
      </div>
      <div class="gridWrap" id="gridWrapHF"></div>
    </section>
  </div>
</main>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const STORAGE_KEY = "lab_scheduler_v2";

  const WEEKDAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
  const WEEKEND  = ["Sat", "Sun"];

  // 9:00–17:00 => 8 one-hour slots: 09-10 ... 16-17
  const TIMES = [];
  for (let h = 9; h < 17; h++) {
    const pad = (n) => String(n).padStart(2, "0");
    TIMES.push(`${pad(h)}:00–${pad(h+1)}:00`);
  }

  const el = (id) => document.getElementById(id);

  const ui = {
    tabWeekdays: el("tab-weekdays"),
    tabWeekend:  el("tab-weekend"),

    viewBoth: el("view-both"),
    viewABC:  el("view-abc"),
    viewHF:   el("view-hf"),

    prevWeekBtn: el("prevWeekBtn"),
    nextWeekBtn: el("nextWeekBtn"),

    panelABC: el("panelABC"),
    panelHF:  el("panelHF"),

    nameInput: el("nameInput"),
    addNameBtn: el("addNameBtn"),

    exportBtn: el("exportBtn"),
    importBtn: el("importBtn"),

    gridWrapABC: el("gridWrapABC"),
    gridWrapHF: el("gridWrapHF"),

    abcSummary: el("abcSummary"),
    hfSummary: el("hfSummary"),

    toast: el("toast"),

    termChip: el("termChip"),
    weekChip: el("weekChip"),
    termNote: el("termNote"),

    adminBtn: el("adminBtn"),
    adminMenu: el("adminMenu"),
    yearSelect: el("yearSelect"),
    termSelect: el("termSelect"),
    applyTermBtn: el("applyTermBtn"),
    resetWeekBtn: el("resetWeekBtn"),
    resetAllBtn: el("resetAllBtn"),
  };

  function toast(msg, kind="info"){
    ui.toast.innerHTML = msg;
    ui.toast.classList.add("show");
    ui.toast.style.borderColor = kind === "bad"
      ? "rgba(255,92,122,.35)"
      : kind === "good"
        ? "rgba(53,208,127,.28)"
        : "rgba(255,255,255,.14)";
    clearTimeout(toast._t);
    toast._t = setTimeout(() => ui.toast.classList.remove("show"), 3000);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Date helpers (local time, Monday as week start)
  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function parseISODate(s){
    // expects YYYY-MM-DD
    const [y,m,dd] = s.split("-").map(Number);
    return new Date(y, (m-1), dd);
  }
  function addDays(d, days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate()+days);
    return x;
  }
  function mondayOfWeek(d){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = x.getDay(); // Sun=0..Sat=6
    const diff = (day === 0 ? -6 : 1 - day); // move to Monday
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }

  function termBounds(year, term){
    // inclusive bounds
    if(term === "Spring"){
      return { start: new Date(year, 0, 1), end: new Date(year, 3, 30) };   // Jan 1 .. Apr 30
    }
    // Fall
    return { start: new Date(year, 8, 1), end: new Date(year, 11, 31) };    // Sep 1 .. Dec 31
  }

  function clampWeekStartToTerm(weekStart, year, term){
    const { start, end } = termBounds(year, term);
    const minWeek = mondayOfWeek(start);
    const maxWeek = mondayOfWeek(end);
    if(weekStart < minWeek) return minWeek;
    if(weekStart > maxWeek) return maxWeek;
    return weekStart;
  }

  function defaultState(){
    // Structure:
    // {
    //   version: 2,
    //   names: [],
    //   settings: { year: 2026, term: "Spring", weekStartISO: "YYYY-MM-DD" },
    //   schedules: { [scopeKey]: { weekdays:{ABC:{...},HF:{...}}, weekend:{...} } }
    // }
    const now = new Date();
    const year = now.getFullYear();
    const termGuess = (now.getMonth() <= 3) ? "Spring" : (now.getMonth() >= 8 ? "Fall" : "Fall");
    const ws = clampWeekStartToTerm(mondayOfWeek(now), year, termGuess);

    return {
      version: 2,
      names: [],
      settings: { year, term: termGuess, weekStartISO: toISODate(ws) },
      schedules: {}
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== "object") return defaultState();
      if(!parsed.settings || !parsed.schedules || !Array.isArray(parsed.names)) return defaultState();
      // upgrade guard: ensure required fields exist
      if(!parsed.settings.year || !parsed.settings.term || !parsed.settings.weekStartISO) return defaultState();
      return parsed;
    }catch{
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // View state
  let activeRange = "weekdays"; // "weekdays" | "weekend"
  let activeView  = "both";     // "both" | "ABC" | "HF"

  function scopeKey(){
    const { year, term, weekStartISO } = state.settings;
    return `${year}::${term}::${weekStartISO}`;
  }

  function ensureScopeData(){
    const key = scopeKey();
    if(state.schedules[key]) return;

    const makeSlots = (days) => {
      const dayObj = {};
      for (const d of days) {
        dayObj[d] = {};
        for (const t of TIMES) dayObj[d][t] = { person: "", participantScheduled: false };
      }
      return dayObj;
    };

    state.schedules[key] = {
      weekdays: { ABC: makeSlots(WEEKDAYS), HF: makeSlots(WEEKDAYS) },
      weekend:  { ABC: makeSlots(WEEKEND),  HF: makeSlots(WEEKEND)  }
    };
  }

  function currentSlots(){
    ensureScopeData();
    return state.schedules[scopeKey()];
  }

  function setRange(range){
    activeRange = range;
    ui.tabWeekdays.classList.toggle("active", range === "weekdays");
    ui.tabWeekend.classList.toggle("active",  range === "weekend");
    renderAll();
  }

  function setView(view){
    activeView = view;

    ui.viewBoth.classList.toggle("active", view === "both");
    ui.viewABC.classList.toggle("active",  view === "ABC");
    ui.viewHF.classList.toggle("active",   view === "HF");

    ui.panelABC.classList.toggle("hidden", view === "HF");
    ui.panelHF.classList.toggle("hidden",  view === "ABC");
  }

  function normalizeName(name){
    return name.trim().replace(/\s+/g, " ");
  }

  function addName(name){
    const n = normalizeName(name);
    if(!n) return;

    const exists = state.names.some(x => x.toLowerCase() === n.toLowerCase());
    if(exists){
      toast(`Name already exists: <strong>${escapeHtml(n)}</strong>`, "bad");
      return;
    }

    state.names.push(n);
    state.names.sort((a,b) => a.localeCompare(b));
    saveState();
    renderAll();
    toast(`Added <strong>${escapeHtml(n)}</strong>`, "good");
  }

  function countFilled(){
    const slots = currentSlots()[activeRange];
    const countFor = (ctx) => {
      let filled = 0;
      let flagged = 0;
      const days = Object.keys(slots[ctx]);
      for(const d of days){
        for(const t of Object.keys(slots[ctx][d])){
          const s = slots[ctx][d][t];
          if(s.person) filled++;
          if(s.participantScheduled) flagged++;
        }
      }
      return { filled, flagged };
    };
    return { ABC: countFor("ABC"), HF: countFor("HF") };
  }

  function renderTopChips(){
    const { year, term, weekStartISO } = state.settings;
    const ws = parseISODate(weekStartISO);
    const we = addDays(ws, 6);
    const label = term === "Spring" ? "Jan–Apr (Spring)" : "Sep–Dec (Fall)";
    ui.termChip.innerHTML = `Term: <strong>${escapeHtml(String(year))} • ${escapeHtml(label)}</strong>`;
    ui.weekChip.innerHTML = `Week: <strong>${escapeHtml(toISODate(ws))} → ${escapeHtml(toISODate(we))}</strong>`;
  }

  function dayDateLabel(dayAbbrev){
    const ws = parseISODate(state.settings.weekStartISO);
    const map = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
    const d = addDays(ws, map[dayAbbrev]);
    return `${dayAbbrev} (${toISODate(d)})`;
  }

  function renderSummary(){
    const c = countFilled();
    ui.abcSummary.className = "badge";
    ui.hfSummary.className = "badge";

    ui.abcSummary.textContent = `${c.ABC.filled} filled • ${c.ABC.flagged} participant`;
    ui.hfSummary.textContent  = `${c.HF.filled} filled • ${c.HF.flagged} participant`;

    if(c.ABC.flagged) ui.abcSummary.classList.add("bad");
    if(c.HF.flagged)  ui.hfSummary.classList.add("bad");
  }

  function renderContext(ctxId, wrapEl){
    const days = activeRange === "weekdays" ? WEEKDAYS : WEEKEND;
    const slots = currentSlots()[activeRange][ctxId];

    const table = document.createElement("table");
    table.setAttribute("aria-label", `${ctxId} schedule table`);

    const thead = document.createElement("thead");
    const hr = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.textContent = "Time";
    hr.appendChild(th0);

    for(const d of days){
      const th = document.createElement("th");
      th.textContent = dayDateLabel(d);
      hr.appendChild(th);
    }
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for(const time of TIMES){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.textContent = time;
      tr.appendChild(th);

      for(const day of days){
        const td = document.createElement("td");
        const s = slots[day][time];

        const slot = document.createElement("div");
        slot.className = "slot";

        const top = document.createElement("div");
        top.className = "slotTop";

        const who = document.createElement("div");
        who.className = "who";
        who.title = s.person || "Unassigned";
        who.textContent = s.person || "—";

        const clearBtn = document.createElement("button");
        clearBtn.className = "smallBtn";
        clearBtn.type = "button";
        clearBtn.textContent = "Clear";
        clearBtn.disabled = !s.person && !s.participantScheduled;
        clearBtn.addEventListener("click", () => {
          slots[day][time] = { person: "", participantScheduled: false };
          saveState();
          renderAll();
        });

        top.appendChild(who);
        top.appendChild(clearBtn);

        const sel = document.createElement("select");
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Select person…";
        sel.appendChild(opt0);

        for(const name of state.names){
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }
        sel.value = s.person || "";
        sel.addEventListener("change", () => {
          slots[day][time].person = sel.value;
          saveState();
          renderAll();
        });

        const inline = document.createElement("div");
        inline.className = "inline";

        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!s.participantScheduled;
        cb.addEventListener("change", () => {
          slots[day][time].participantScheduled = cb.checked;
          saveState();
          renderAll();
        });

        const span = document.createElement("span");
        span.textContent = "Participant scheduled";

        label.appendChild(cb);
        label.appendChild(span);
        inline.appendChild(label);

        const badge = document.createElement("div");
        badge.className = "badge";
        if(s.participantScheduled){
          badge.classList.add("bad");
          badge.textContent = "⚠ Must be present (participant scheduled)";
        }else if(s.person){
          badge.classList.add("good");
          badge.textContent = "Scheduled";
        }else{
          badge.textContent = "Open";
        }

        slot.appendChild(top);
        slot.appendChild(sel);
        slot.appendChild(inline);
        slot.appendChild(badge);

        td.appendChild(slot);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    wrapEl.innerHTML = "";
    wrapEl.appendChild(table);
  }

  function renderAll(){
    ensureScopeData();
    renderTopChips();
    renderContext("ABC", ui.gridWrapABC);
    renderContext("HF", ui.gridWrapHF);
    renderSummary();
    setView(activeView);
  }

  // Week navigation constrained to term
  function shiftWeek(deltaWeeks){
    const { year, term } = state.settings;
    let ws = parseISODate(state.settings.weekStartISO);
    ws = addDays(ws, deltaWeeks * 7);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);
    saveState();
    renderAll();
  }

  // Export / Import
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportState(){
    const payload = {
      ...state,
      exportedAt: new Date().toISOString()
    };
    downloadText("lab-schedule-export.json", JSON.stringify(payload, null, 2));
    toast("Exported JSON.", "good");
  }

  async function importState(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.addEventListener("change", async () => {
      const file = input.files && input.files[0];
      if(!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        if(!parsed || typeof parsed !== "object" || !parsed.settings || !parsed.schedules || !Array.isArray(parsed.names)){
          toast("Import failed: JSON missing expected fields (settings, names, schedules).", "bad");
          return;
        }

        state = parsed;

        // normalize current week to term bounds
        const { year, term } = state.settings;
        let ws = parseISODate(state.settings.weekStartISO);
        ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
        state.settings.weekStartISO = toISODate(ws);

        saveState();
        renderAll();
        toast("Imported JSON.", "good");
      }catch{
        toast("Import failed: invalid JSON.", "bad");
      }
    });
    input.click();
  }

  // Admin menu behavior
  function toggleAdminMenu(force){
    const show = (typeof force === "boolean") ? force : !ui.adminMenu.classList.contains("show");
    ui.adminMenu.classList.toggle("show", show);
  }

  function populateYearSelect(){
    const now = new Date().getFullYear();
    const years = [];
    for(let y = now - 2; y <= now + 4; y++) years.push(y);
    ui.yearSelect.innerHTML = "";
    for(const y of years){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      ui.yearSelect.appendChild(opt);
    }
  }

  function syncAdminFields(){
    ui.yearSelect.value = String(state.settings.year);
    ui.termSelect.value = state.settings.term;
  }

  function applyYearTerm(){
    const year = Number(ui.yearSelect.value);
    const term = ui.termSelect.value;

    state.settings.year = year;
    state.settings.term = term;

    // reset weekStart into the chosen term if out of bounds
    let ws = parseISODate(state.settings.weekStartISO);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);

    saveState();
    renderAll();
    toast(`Applied <strong>${year}</strong> • <strong>${escapeHtml(term)}</strong>.`, "good");
  }

  function resetThisWeek(){
    const ok = confirm("Reset ONLY the current week for this Year/Term (both contexts, weekdays + weekend)?");
    if(!ok) return;

    ensureScopeData();
    const key = scopeKey();
    delete state.schedules[key];
    ensureScopeData();

    saveState();
    renderAll();
    toast("Reset current week.", "good");
  }

  function resetAll(){
    const ok = confirm("Reset ALL data (names + all schedules) in this browser?");
    if(!ok) return;
    state = defaultState();
    saveState();
    populateYearSelect();
    syncAdminFields();
    renderAll();
    toast("Reset ALL data.", "good");
  }

  // Wire UI
  ui.tabWeekdays.addEventListener("click", () => setRange("weekdays"));
  ui.tabWeekend.addEventListener("click",  () => setRange("weekend"));

  ui.viewBoth.addEventListener("click", () => setView("both"));
  ui.viewABC.addEventListener("click",  () => setView("ABC"));
  ui.viewHF.addEventListener("click",   () => setView("HF"));

  ui.prevWeekBtn.addEventListener("click", () => shiftWeek(-1));
  ui.nextWeekBtn.addEventListener("click", () => shiftWeek(1));

  ui.addNameBtn.addEventListener("click", () => {
    addName(ui.nameInput.value);
    ui.nameInput.value = "";
    ui.nameInput.focus();
  });
  ui.nameInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      addName(ui.nameInput.value);
      ui.nameInput.value = "";
    }
  });

  ui.exportBtn.addEventListener("click", exportState);
  ui.importBtn.addEventListener("click", importState);

  ui.adminBtn.addEventListener("click", () => {
    syncAdminFields();
    toggleAdminMenu();
  });

  ui.applyTermBtn.addEventListener("click", () => applyYearTerm());
  ui.resetWeekBtn.addEventListener("click", () => resetThisWeek());
  ui.resetAllBtn.addEventListener("click", () => resetAll());

  // Close admin menu when clicking outside
  document.addEventListener("click", (e) => {
    const inside = ui.adminMenu.contains(e.target) || ui.adminBtn.contains(e.target);
    if(!inside) toggleAdminMenu(false);
  });

  // init
  populateYearSelect();

  // Ensure settings are term-valid on load
  {
    const { year, term } = state.settings;
    let ws = parseISODate(state.settings.weekStartISO);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);
    saveState();
  }

  renderAll();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABC Lab Schedule</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:#e7ecff;
      --muted:#b8c0e0;
      --accent:#7aa2ff;
      --good:#35d07f;
      --bad:#ff5c7a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, #1a2a66 0%, var(--bg) 60%),
                  radial-gradient(1200px 800px at 90% 20%, #3b1a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{padding:18px 18px 0;max-width:1400px;margin:0 auto;}
    .titlebar{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;}
    h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .subtitle{margin:6px 0 0;font-size:13px;color:var(--muted);line-height:1.35;max-width:980px;}

    main{padding:14px 18px 24px;max-width:1400px;margin:0 auto;}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
    }
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .leftControls,.rightControls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    .tabs{
      display:inline-flex;background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);border-radius:999px;
      padding:4px;gap:4px;
    }
    .tab{
      border:0;color:var(--muted);background:transparent;
      padding:7px 10px;border-radius:999px;font-size:12px;cursor:pointer;user-select:none;
    }
    .tab.active{
      background:rgba(122,162,255,.18);color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(122,162,255,.25);
    }

    .btn{
      border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{background:rgba(122,162,255,.18);border-color:rgba(122,162,255,.25);}
    .btn.danger{background:rgba(255,92,122,.12);border-color:rgba(255,92,122,.28);}

    .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input[type="text"], input[type="password"]{
      background:rgba(0,0,0,.22);color:var(--text);
      border:1px solid rgba(255,255,255,.10);border-radius:10px;
      padding:8px 10px;font-size:12px;min-width:240px;outline:none;
    }
    input[type="text"]::placeholder, input[type="password"]::placeholder{color:rgba(184,192,224,.75)}

    .chip{
      display:inline-flex;align-items:center;gap:8px;background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;
      font-size:12px;color:var(--muted);
    }
    .chip strong{color:var(--text); font-weight:700}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}

    .gridWrap{
      overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08);
      margin-top:12px;background:rgba(0,0,0,.12);
    }
    table{border-collapse:separate;border-spacing:0;min-width:980px;width:100%;font-size:12px;}
    thead th{
      position:sticky;top:0;z-index:5;background:rgba(10,14,30,.92);backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;text-align:left;color:var(--muted);
      font-weight:700;white-space:nowrap;
    }
    thead th:first-child{left:0; z-index:6;}
    tbody th{
      position:sticky;left:0;z-index:4;background:rgba(10,14,30,.92);backdrop-filter: blur(6px);
      border-right:1px solid rgba(255,255,255,.10);color:var(--muted);font-weight:700;padding:10px 8px;
      white-space:nowrap;font-family:var(--mono);
    }
    td{
      border-bottom:1px solid rgba(255,255,255,.07);border-right:1px solid rgba(255,255,255,.07);
      padding:8px;vertical-align:top;min-width:190px;background:rgba(17,26,51,.35);
    }
    tr:last-child td{border-bottom:0}
    td:last-child{border-right:0}

    .slot{display:flex;flex-direction:column;gap:6px;min-height:92px;}
    select{
      width:100%;background:rgba(0,0,0,.22);color:var(--text);
      border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:7px 8px;font-size:12px;outline:none;
    }
    .slotTop{display:flex;gap:8px;align-items:center;justify-content:space-between;}
    .who{font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px;}
    .smallBtn{
      border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);
      padding:6px 8px;border-radius:10px;font-size:11px;cursor:pointer;
    }
    .smallBtn:hover{border-color:rgba(255,255,255,.18)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:5px 8px;font-size:11px;
      background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);color:var(--muted);width:max-content;
    }
    .badge.bad{background:rgba(255,92,122,.12); border-color:rgba(255,92,122,.25); color:var(--text)}
    .badge.good{background:rgba(53,208,127,.12); border-color:rgba(53,208,127,.22); color:var(--text)}
    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    label{display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none; color:var(--muted);}
    input[type="checkbox"]{width:15px;height:15px;accent-color:var(--accent);}

    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width: 1050px){.twoCol{grid-template-columns:1fr}table{min-width:920px}}
    .hidden{display:none !important}

    .toast{
      position:fixed;bottom:16px;right:16px;background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(10px);box-shadow:var(--shadow);
      padding:10px 12px;border-radius:12px;font-size:12px;color:var(--text);
      max-width:min(560px, calc(100vw - 32px));display:none;
    }
    .toast.show{display:block}

    /* Admin dropdown */
    .menuWrap{position:relative; display:inline-block;}
    .menu{
      position:absolute;right:0;top:42px;width:min(400px, calc(100vw - 24px));
      background:rgba(10,14,30,.96);border:1px solid rgba(255,255,255,.12);
      border-radius:14px;box-shadow:var(--shadow);padding:12px;z-index:50;display:none;
    }
    .menu.show{display:block}
    .menu h3{margin:0 0 10px 0;font-size:13px;color:var(--text);}
    .menuRow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:10px;}
    .menuRow > div{flex:1;min-width:160px;}
    .menu small{color:var(--muted); display:block; line-height:1.35;}
    .statusDot{
      display:inline-block;width:9px;height:9px;border-radius:999px;background:rgba(255,255,255,.25);
      box-shadow:0 0 0 2px rgba(0,0,0,.18) inset;
      margin-right:6px;
    }
    .dotGood{background:rgba(53,208,127,.85)}
    .dotBad{background:rgba(255,92,122,.85)}
  </style>
</head>

<body>
<header>
  <div class="titlebar">
    <div>
      <h1>ABC Lab Schedule</h1>
      <p class="subtitle">
        Shared schedule backed by Google Sheets. 1-hour slots. Weekdays: <strong>Mon–Fri, 09:00–17:00</strong>. Weekend scheduling is separate.
        Scope: <strong>Year + Term + Week</strong>.
      </p>
    </div>
    <div class="inline" style="align-items:center;">
      <span class="chip" id="connChip"><span class="statusDot" id="connDot"></span>Backend: <strong id="connLabel">—</strong></span>
      <span class="chip" id="termChip">Term: <strong>—</strong></span>
      <span class="chip" id="weekChip">Week: <strong>—</strong></span>
      <div class="menuWrap">
        <button class="btn" id="adminBtn" type="button">Admin ▾</button>
        <div class="menu" id="adminMenu" aria-label="Admin menu">
          <h3>Admin</h3>
          <div class="menuRow">
            <div>
              <small>Year</small>
              <select id="yearSelect"></select>
            </div>
            <div>
              <small>Term</small>
              <select id="termSelect">
                <option value="Spring">Jan–Apr (Spring)</option>
                <option value="Fall">Sep–Dec (Fall)</option>
              </select>
            </div>
          </div>
          <div class="menuRow">
            <div style="flex:1;min-width:220px;">
              <small>Admin key (only needed for reset if enabled in Apps Script)</small>
              <input id="adminKeyInput" type="password" placeholder="Admin key (optional)" />
            </div>
          </div>
          <div class="menuRow">
            <button class="btn primary" id="applyTermBtn" type="button">Apply Year/Term</button>
            <button class="btn danger" id="resetWeekBtn" type="button">Reset this week</button>
          </div>
          <div class="menuRow" style="margin-bottom:0;">
            <button class="btn danger" id="resetAllBtn" type="button">Reset ALL data</button>
          </div>
          <small style="margin-top:10px;">
            Reset this week clears only the current week (both contexts, weekdays+weekend) for the selected Year/Term.
            Reset ALL wipes names and all schedules in the shared Sheet.
          </small>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="controls">
      <div class="leftControls">
        <div class="tabs" role="tablist" aria-label="Schedule range">
          <button class="tab active" id="tab-weekdays" type="button">Weekdays</button>
          <button class="tab" id="tab-weekend" type="button">Weekend</button>
        </div>

        <div class="tabs" role="tablist" aria-label="Context display">
          <button class="tab active" id="view-both" type="button">Both</button>
          <button class="tab" id="view-abc" type="button">ABC only</button>
          <button class="tab" id="view-hf" type="button">HF only</button>
        </div>

        <div class="inline">
          <button class="btn" id="prevWeekBtn" type="button">◀ Prev week</button>
          <button class="btn" id="nextWeekBtn" type="button">Next week ▶</button>
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
        </div>
      </div>

      <div class="rightControls">
        <div class="field">
          <input id="nameInput" type="text" placeholder="Add person (e.g., Jane Doe) and press Enter" />
          <button class="btn primary" id="addNameBtn" type="button">Add</button>
        </div>
        <button class="btn" id="exportBtn" type="button">Export</button>
        <button class="btn" id="importBtn" type="button">Import</button>
      </div>
    </div>

    <p class="note" id="termNote">
      Term limits: Jan–Apr (Spring) and Sep–Dec (Fall). Week navigation is constrained to the active term.
      Use <strong>Refresh</strong> to pull the latest updates from other users.
    </p>
  </div>

  <div class="twoCol" style="margin-top:12px;">
    <section class="panel" id="panelABC">
      <div class="inline" style="justify-content:space-between;">
        <div class="inline">
          <span class="chip">Context: <strong>ABC Lab</strong></span>
        </div>
        <span class="badge" id="abcSummary">0 filled</span>
      </div>
      <div class="gridWrap" id="gridWrapABC"></div>
    </section>

    <section class="panel" id="panelHF">
      <div class="inline" style="justify-content:space-between;">
        <div class="inline">
          <span class="chip">Context: <strong>HF Project</strong></span>
        </div>
        <span class="badge" id="hfSummary">0 filled</span>
      </div>
      <div class="gridWrap" id="gridWrapHF"></div>
    </section>
  </div>
</main>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // =============================
  // CONFIG
  // =============================
  const API_URL = "https://script.google.com/macros/s/AKfycbwfNCwtEJmeWsP9bTaa6xXYTLSRWCuXb86An5EemgP1SIAnTYiJLx55MP92m2fArwXv5A/exec";
  const LOCAL_CACHE_KEY = "abc_lab_schedule_cache_v1"; // optional cache (not authoritative)

  const WEEKDAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
  const WEEKEND  = ["Sat", "Sun"];

  // 9:00–17:00 => 8 one-hour slots
  const TIMES = [];
  for (let h = 9; h < 17; h++) {
    const pad = (n) => String(n).padStart(2, "0");
    TIMES.push(`${pad(h)}:00–${pad(h+1)}:00`);
  }

  const el = (id) => document.getElementById(id);

  const ui = {
    tabWeekdays: el("tab-weekdays"),
    tabWeekend:  el("tab-weekend"),

    viewBoth: el("view-both"),
    viewABC:  el("view-abc"),
    viewHF:   el("view-hf"),

    prevWeekBtn: el("prevWeekBtn"),
    nextWeekBtn: el("nextWeekBtn"),
    refreshBtn:  el("refreshBtn"),

    panelABC: el("panelABC"),
    panelHF:  el("panelHF"),

    nameInput: el("nameInput"),
    addNameBtn: el("addNameBtn"),

    exportBtn: el("exportBtn"),
    importBtn: el("importBtn"),

    gridWrapABC: el("gridWrapABC"),
    gridWrapHF: el("gridWrapHF"),

    abcSummary: el("abcSummary"),
    hfSummary: el("hfSummary"),

    toast: el("toast"),

    termChip: el("termChip"),
    weekChip: el("weekChip"),

    connDot: el("connDot"),
    connLabel: el("connLabel"),

    adminBtn: el("adminBtn"),
    adminMenu: el("adminMenu"),
    yearSelect: el("yearSelect"),
    termSelect: el("termSelect"),
    adminKeyInput: el("adminKeyInput"),
    applyTermBtn: el("applyTermBtn"),
    resetWeekBtn: el("resetWeekBtn"),
    resetAllBtn: el("resetAllBtn"),
  };

  function toast(msg, kind="info"){
    ui.toast.innerHTML = msg;
    ui.toast.classList.add("show");
    ui.toast.style.borderColor = kind === "bad"
      ? "rgba(255,92,122,.35)"
      : kind === "good"
        ? "rgba(53,208,127,.28)"
        : "rgba(255,255,255,.14)";
    clearTimeout(toast._t);
    toast._t = setTimeout(() => ui.toast.classList.remove("show"), 3000);
  }

  // =============================
  // API
  // =============================
  async function apiPost(action, payload = {}) {
  const body = JSON.stringify({ action, ...payload });

  const res = await fetch(API_URL, {
    method: "POST",
    // IMPORTANT: text/plain avoids CORS preflight; Apps Script can still read e.postData.contents
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body
  });

  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); }
  catch { data = { ok:false, error:"Non-JSON response from backend." }; }

  if (!data.ok) throw new Error(data.error || "Backend error");
  return data;
}


  async function backendPing() {
    try {
      const data = await apiPost("ping", {});
      setBackendStatus(true);
      return data;
    } catch (e) {
      setBackendStatus(false);
      throw e;
    }
  }

  function setBackendStatus(ok) {
    ui.connDot.classList.remove("dotGood","dotBad");
    ui.connDot.classList.add(ok ? "dotGood" : "dotBad");
    ui.connLabel.textContent = ok ? "Connected" : "Offline";
  }

  // =============================
  // Date helpers (local time)
  // =============================
  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function parseISODate(s){
    const [y,m,dd] = s.split("-").map(Number);
    return new Date(y, (m-1), dd);
  }
  function addDays(d, days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate()+days);
    return x;
  }
  function mondayOfWeek(d){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = x.getDay(); // Sun=0..Sat=6
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }
  function termBounds(year, term){
    if(term === "Spring"){
      return { start: new Date(year, 0, 1), end: new Date(year, 3, 30) };   // Jan 1 .. Apr 30
    }
    return { start: new Date(year, 8, 1), end: new Date(year, 11, 31) };    // Sep 1 .. Dec 31
  }
  function clampWeekStartToTerm(weekStart, year, term){
    const { start, end } = termBounds(year, term);
    const minWeek = mondayOfWeek(start);
    const maxWeek = mondayOfWeek(end);
    if(weekStart < minWeek) return minWeek;
    if(weekStart > maxWeek) return maxWeek;
    return weekStart;
  }
  function dayDateLabel(dayAbbrev, weekStartISO){
    const ws = parseISODate(weekStartISO);
    const map = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
    const d = addDays(ws, map[dayAbbrev]);
    return `${dayAbbrev} (${toISODate(d)})`;
  }

  // =============================
  // State (authoritative on backend)
  // =============================
  function defaultState(){
    const now = new Date();
    const year = now.getFullYear();
    const termGuess = (now.getMonth() <= 3) ? "Spring" : (now.getMonth() >= 8 ? "Fall" : "Fall");
    const ws = clampWeekStartToTerm(mondayOfWeek(now), year, termGuess);
    return {
      version: 1,
      names: [],
      settings: {
        year,
        term: termGuess,
        weekStartISO: toISODate(ws)
      },
      cacheSlotsByScope: {} // local cache only
    };
  }

  function loadCache(){
    try{
      const raw = localStorage.getItem(LOCAL_CACHE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== "object" || !parsed.settings) return defaultState();
      if(!parsed.cacheSlotsByScope) parsed.cacheSlotsByScope = {};
      if(!Array.isArray(parsed.names)) parsed.names = [];
      return parsed;
    }catch{
      return defaultState();
    }
  }

  function saveCache(){
    localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(state));
  }

  let state = loadCache();

  let activeRange = "weekdays"; // "weekdays" | "weekend"
  let activeView  = "both";     // "both" | "ABC" | "HF"

  function scopeKey(){
    const { year, term, weekStartISO } = state.settings;
    return `${year}::${term}::${weekStartISO}`;
  }

  function ensureLocalScopeStructure(scope){
    if(state.cacheSlotsByScope[scope]) return;
    const makeSlots = (days) => {
      const dayObj = {};
      for (const d of days) {
        dayObj[d] = {};
        for (const t of TIMES) dayObj[d][t] = { person: "", participantScheduled: false };
      }
      return dayObj;
    };
    state.cacheSlotsByScope[scope] = {
      weekdays: { ABC: makeSlots(WEEKDAYS), HF: makeSlots(WEEKDAYS) },
      weekend:  { ABC: makeSlots(WEEKEND),  HF: makeSlots(WEEKEND)  }
    };
  }

  function currentLocalSlots(){
    const s = scopeKey();
    ensureLocalScopeStructure(s);
    return state.cacheSlotsByScope[s];
  }

  // Apply backend week payload (flat key map) into local structure
  function applyWeekFromBackend(data){
    const sKey = data.scopeKey;
    ensureLocalScopeStructure(sKey);

    const slotsStruct = state.cacheSlotsByScope[sKey];
    // reset to defaults first
    const resetStruct = () => {
      const makeSlots = (days) => {
        const dayObj = {};
        for (const d of days) {
          dayObj[d] = {};
          for (const t of TIMES) dayObj[d][t] = { person: "", participantScheduled: false };
        }
        return dayObj;
      };
      slotsStruct.weekdays.ABC = makeSlots(WEEKDAYS);
      slotsStruct.weekdays.HF  = makeSlots(WEEKDAYS);
      slotsStruct.weekend.ABC  = makeSlots(WEEKEND);
      slotsStruct.weekend.HF   = makeSlots(WEEKEND);
    };
    resetStruct();

    const flat = data.slots || {};
    for(const k of Object.keys(flat)){
      const [range, ctx, day, time] = k.split("::");
      if(!slotsStruct[range] || !slotsStruct[range][ctx] || !slotsStruct[range][ctx][day] || !slotsStruct[range][ctx][day][time]) continue;
      slotsStruct[range][ctx][day][time] = {
        person: flat[k].person || "",
        participantScheduled: !!flat[k].participantScheduled
      };
    }
    saveCache();
  }

  // =============================
  // Rendering
  // =============================
  function setRange(range){
    activeRange = range;
    ui.tabWeekdays.classList.toggle("active", range === "weekdays");
    ui.tabWeekend.classList.toggle("active",  range === "weekend");
    renderAll();
  }

  function setView(view){
    activeView = view;
    ui.viewBoth.classList.toggle("active", view === "both");
    ui.viewABC.classList.toggle("active",  view === "ABC");
    ui.viewHF.classList.toggle("active",   view === "HF");
    ui.panelABC.classList.toggle("hidden", view === "HF");
    ui.panelHF.classList.toggle("hidden",  view === "ABC");
  }

  function renderTopChips(){
    const { year, term, weekStartISO } = state.settings;
    const ws = parseISODate(weekStartISO);
    const we = addDays(ws, 6);
    const label = term === "Spring" ? "Jan–Apr (Spring)" : "Sep–Dec (Fall)";
    ui.termChip.innerHTML = `Term: <strong>${year} • ${label}</strong>`;
    ui.weekChip.innerHTML = `Week: <strong>${toISODate(ws)} → ${toISODate(we)}</strong>`;
  }

  function countFilled(){
    const slots = currentLocalSlots()[activeRange];
    const countFor = (ctx) => {
      let filled = 0, flagged = 0;
      const days = Object.keys(slots[ctx]);
      for(const d of days){
        for(const t of Object.keys(slots[ctx][d])){
          const s = slots[ctx][d][t];
          if(s.person) filled++;
          if(s.participantScheduled) flagged++;
        }
      }
      return { filled, flagged };
    };
    return { ABC: countFor("ABC"), HF: countFor("HF") };
  }

  function renderSummary(){
    const c = countFilled();
    ui.abcSummary.className = "badge";
    ui.hfSummary.className = "badge";
    ui.abcSummary.textContent = `${c.ABC.filled} filled • ${c.ABC.flagged} participant`;
    ui.hfSummary.textContent  = `${c.HF.filled} filled • ${c.HF.flagged} participant`;
    if(c.ABC.flagged) ui.abcSummary.classList.add("bad");
    if(c.HF.flagged)  ui.hfSummary.classList.add("bad");
  }

  function renderContext(ctxId, wrapEl){
    const days = activeRange === "weekdays" ? WEEKDAYS : WEEKEND;
    const slots = currentLocalSlots()[activeRange][ctxId];
    const weekStartISO = state.settings.weekStartISO;

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const hr = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.textContent = "Time";
    hr.appendChild(th0);

    for(const d of days){
      const th = document.createElement("th");
      th.textContent = dayDateLabel(d, weekStartISO);
      hr.appendChild(th);
    }
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for(const time of TIMES){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.textContent = time;
      tr.appendChild(th);

      for(const day of days){
        const td = document.createElement("td");
        const s = slots[day][time];

        const slot = document.createElement("div");
        slot.className = "slot";

        const top = document.createElement("div");
        top.className = "slotTop";

        const who = document.createElement("div");
        who.className = "who";
        who.title = s.person || "Unassigned";
        who.textContent = s.person || "—";

        const clearBtn = document.createElement("button");
        clearBtn.className = "smallBtn";
        clearBtn.type = "button";
        clearBtn.textContent = "Clear";
        clearBtn.disabled = !s.person && !s.participantScheduled;
        clearBtn.addEventListener("click", async () => {
          await saveSlotToBackend({
            range: activeRange, context: ctxId, day, time,
            person: "", participantScheduled: false
          }, { optimistic: true });
        });

        top.appendChild(who);
        top.appendChild(clearBtn);

        const sel = document.createElement("select");
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Select person…";
        sel.appendChild(opt0);

        for(const name of state.names){
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }
        sel.value = s.person || "";
        sel.addEventListener("change", async () => {
          await saveSlotToBackend({
            range: activeRange, context: ctxId, day, time,
            person: sel.value, participantScheduled: !!slots[day][time].participantScheduled
          }, { optimistic: true });
        });

        const inline = document.createElement("div");
        inline.className = "inline";

        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!s.participantScheduled;
        cb.addEventListener("change", async () => {
          await saveSlotToBackend({
            range: activeRange, context: ctxId, day, time,
            person: slots[day][time].person || "",
            participantScheduled: cb.checked
          }, { optimistic: true });
        });

        const span = document.createElement("span");
        span.textContent = "Participant scheduled";

        label.appendChild(cb);
        label.appendChild(span);
        inline.appendChild(label);

        const badge = document.createElement("div");
        badge.className = "badge";
        if(s.participantScheduled){
          badge.classList.add("bad");
          badge.textContent = "⚠ Must be present (participant scheduled)";
        }else if(s.person){
          badge.classList.add("good");
          badge.textContent = "Scheduled";
        }else{
          badge.textContent = "Open";
        }

        slot.appendChild(top);
        slot.appendChild(sel);
        slot.appendChild(inline);
        slot.appendChild(badge);

        td.appendChild(slot);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    wrapEl.innerHTML = "";
    wrapEl.appendChild(table);
  }

  function renderAll(){
    renderTopChips();
    renderContext("ABC", ui.gridWrapABC);
    renderContext("HF", ui.gridWrapHF);
    renderSummary();
    setView(activeView);
  }

  // =============================
  // Backend-backed operations
  // =============================
  async function loadNamesFromBackend(){
    const data = await apiPost("listNames", {});
    state.names = Array.isArray(data.names) ? data.names : [];
    saveCache();
  }

  async function addNameToBackend(nameRaw){
    const name = String(nameRaw || "").trim().replace(/\s+/g," ");
    if(!name) return;
    await apiPost("addName", { name });
    await loadNamesFromBackend();
    toast(`Added <strong>${name}</strong>`, "good");
    renderAll();
  }

  async function loadWeekFromBackend(){
    const { year, term, weekStartISO } = state.settings;
    const data = await apiPost("loadWeek", { year, term, weekStartISO });
    applyWeekFromBackend(data.data);
    renderAll();
    toast("Refreshed from shared Sheet.", "good");
  }

  async function saveSlotToBackend(slot, { optimistic } = { optimistic: true }){
    const { year, term, weekStartISO } = state.settings;
    const payload = {
      year, term, weekStartISO,
      range: slot.range,
      context: slot.context,
      day: slot.day,
      time: slot.time,
      person: slot.person || "",
      participantScheduled: !!slot.participantScheduled,
      updatedBy: "" // optional: you can add a "Your name" field later if desired
    };

    // optimistic local update
    if(optimistic){
      const s = currentLocalSlots();
      s[slot.range][slot.context][slot.day][slot.time] = {
        person: payload.person,
        participantScheduled: payload.participantScheduled
      };
      saveCache();
      renderAll();
    }

    try{
      await apiPost("saveSlot", payload);
      setBackendStatus(true);
    }catch(e){
      setBackendStatus(false);
      toast(`Save failed: ${e.message}. (Your view may be out of sync; hit Refresh.)`, "bad");
    }
  }

  // =============================
  // Week navigation (term constrained)
  // =============================
  function shiftWeek(deltaWeeks){
    const { year, term } = state.settings;
    let ws = parseISODate(state.settings.weekStartISO);
    ws = addDays(ws, deltaWeeks * 7);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);
    saveCache();
    // load from backend for new week
    loadWeekFromBackend().catch(e => toast(`Load failed: ${e.message}`, "bad"));
  }

  // =============================
  // Admin
  // =============================
  function toggleAdminMenu(force){
    const show = (typeof force === "boolean") ? force : !ui.adminMenu.classList.contains("show");
    ui.adminMenu.classList.toggle("show", show);
  }

  function populateYearSelect(){
    const now = new Date().getFullYear();
    ui.yearSelect.innerHTML = "";
    for(let y = now - 2; y <= now + 4; y++){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      ui.yearSelect.appendChild(opt);
    }
  }

  function syncAdminFields(){
    ui.yearSelect.value = String(state.settings.year);
    ui.termSelect.value = state.settings.term;
    ui.adminKeyInput.value = state.settings.adminKey || "";
  }

  function applyYearTerm(){
    const year = Number(ui.yearSelect.value);
    const term = ui.termSelect.value;

    state.settings.year = year;
    state.settings.term = term;
    state.settings.adminKey = ui.adminKeyInput.value || "";

    let ws = parseISODate(state.settings.weekStartISO);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);

    saveCache();
    renderAll();
    loadWeekFromBackend().catch(e => toast(`Load failed: ${e.message}`, "bad"));
    toast(`Applied <strong>${year}</strong> • <strong>${term}</strong>.`, "good");
  }

  async function resetWeek(){
    const ok = confirm("Reset ONLY the current week for this Year/Term (both contexts, weekdays + weekend) in the shared Sheet?");
    if(!ok) return;

    const { year, term, weekStartISO } = state.settings;
    const adminKey = ui.adminKeyInput.value || state.settings.adminKey || "";
    try{
      await apiPost("resetWeek", { year, term, weekStartISO, adminKey });
      await loadWeekFromBackend();
      toast("Reset current week (shared).", "good");
    }catch(e){
      toast(`Reset failed: ${e.message}`, "bad");
    }
  }

  async function resetAll(){
    const ok = confirm("Reset ALL data (names + all schedules) in the shared Sheet?");
    if(!ok) return;

    const adminKey = ui.adminKeyInput.value || state.settings.adminKey || "";
    try{
      await apiPost("resetAll", { adminKey });
      await loadNamesFromBackend();
      await loadWeekFromBackend();
      toast("Reset ALL data (shared).", "good");
    }catch(e){
      toast(`Reset failed: ${e.message}`, "bad");
    }
  }

  // =============================
  // Export / Import (local cache)
  // =============================
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportLocal(){
    const payload = {
      exportedAt: new Date().toISOString(),
      names: state.names,
      settings: state.settings,
      cachedScope: scopeKey(),
      cachedSlots: currentLocalSlots()
    };
    downloadText("abc-lab-schedule-local-export.json", JSON.stringify(payload, null, 2));
    toast("Exported local snapshot.", "good");
  }

  async function importLocal(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.addEventListener("change", async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!parsed || typeof parsed !== "object") throw new Error("Invalid JSON.");
        if(!Array.isArray(parsed.names) || !parsed.settings) throw new Error("Missing names/settings.");

        // import into local cache only
        state.names = parsed.names;
        state.settings = { ...state.settings, ...parsed.settings };
        if(parsed.cachedScope && parsed.cachedSlots){
          state.cacheSlotsByScope[parsed.cachedScope] = parsed.cachedSlots;
        }
        saveCache();
        renderAll();

        // then refresh from backend to sync real data
        await loadNamesFromBackend();
        await loadWeekFromBackend();
        toast("Imported local snapshot and refreshed from backend.", "good");
      }catch(e){
        toast(`Import failed: ${e.message}`, "bad");
      }
    });
    input.click();
  }

  // =============================
  // Wire UI
  // =============================
  ui.tabWeekdays.addEventListener("click", () => setRange("weekdays"));
  ui.tabWeekend.addEventListener("click",  () => setRange("weekend"));

  ui.viewBoth.addEventListener("click", () => setView("both"));
  ui.viewABC.addEventListener("click",  () => setView("ABC"));
  ui.viewHF.addEventListener("click",   () => setView("HF"));

  ui.prevWeekBtn.addEventListener("click", () => shiftWeek(-1));
  ui.nextWeekBtn.addEventListener("click", () => shiftWeek(1));
  ui.refreshBtn.addEventListener("click", () => loadWeekFromBackend().catch(e => toast(`Refresh failed: ${e.message}`, "bad")));

  ui.addNameBtn.addEventListener("click", async () => {
    const v = ui.nameInput.value;
    ui.nameInput.value = "";
    ui.nameInput.focus();
    try { await addNameToBackend(v); }
    catch(e){ toast(`Add failed: ${e.message}`, "bad"); }
  });

  ui.nameInput.addEventListener("keydown", async (e) => {
    if(e.key === "Enter"){
      const v = ui.nameInput.value;
      ui.nameInput.value = "";
      try { await addNameToBackend(v); }
      catch(err){ toast(`Add failed: ${err.message}`, "bad"); }
    }
  });

  ui.exportBtn.addEventListener("click", exportLocal);
  ui.importBtn.addEventListener("click", importLocal);

  ui.adminBtn.addEventListener("click", () => {
    syncAdminFields();
    toggleAdminMenu();
  });

  ui.applyTermBtn.addEventListener("click", () => applyYearTerm());
  ui.resetWeekBtn.addEventListener("click", () => resetWeek());
  ui.resetAllBtn.addEventListener("click", () => resetAll());

  document.addEventListener("click", (e) => {
    const inside = ui.adminMenu.contains(e.target) || ui.adminBtn.contains(e.target);
    if(!inside) toggleAdminMenu(false);
  });

  // =============================
  // Init
  // =============================
  populateYearSelect();

  // normalize settings weekStart to term bounds
  {
    const { year, term } = state.settings;
    let ws = parseISODate(state.settings.weekStartISO);
    ws = clampWeekStartToTerm(mondayOfWeek(ws), year, term);
    state.settings.weekStartISO = toISODate(ws);
    saveCache();
  }

  (async () => {
    try{
      await backendPing();
      await loadNamesFromBackend();
      await loadWeekFromBackend();
    }catch(e){
      toast(`Backend not reachable: ${e.message}. Showing local cache.`, "bad");
      renderAll();
    }
  })();
})();
</script>
</body>
</html>
